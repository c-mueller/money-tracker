{{define "content"}}
<h1>{{if .RecurringExpense}}{{t "edit_recurring"}}{{else}}{{t "new_recurring"}}{{end}}</h1>
<p class="text-muted">{{.Household.Name}} â€” {{.Household.Currency}}</p>

<form method="POST" action="{{if .RecurringExpense}}/households/{{.Household.ID}}/recurring/{{.RecurringExpense.ID}}{{else}}/households/{{.Household.ID}}/recurring{{end}}" class="mt-3" style="max-width: 500px;">
    <div class="mb-3">
        <label for="name" class="form-label">{{t "name"}}</label>
        <input type="text" class="form-control" id="name" name="name" required maxlength="100" value="{{if .RecurringExpense}}{{.RecurringExpense.Name}}{{end}}">
    </div>
    <div class="mb-3">
        <label class="form-label">{{t "type"}}</label>
        <div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="type" id="type-expense" value="expense" {{if not .RecurringExpense}}checked{{else}}{{if isNegative .RecurringExpense.Amount}}checked{{end}}{{end}}>
                <label class="form-check-label" for="type-expense">{{t "expense"}}</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="type" id="type-income" value="income" {{if .RecurringExpense}}{{if not (isNegative .RecurringExpense.Amount)}}checked{{end}}{{end}}>
                <label class="form-check-label" for="type-income">{{t "income"}}</label>
            </div>
        </div>
    </div>
    <div class="mb-3">
        <label for="amount" class="form-label">{{t "amount"}}</label>
        <input type="text" class="form-control" id="amount" name="amount" required placeholder="e.g. 42.50" value="{{if .RecurringExpense}}{{absAmount .RecurringExpense.Amount}}{{end}}">
    </div>
    <div class="mb-3">
        <label for="description" class="form-label">{{t "description"}}</label>
        <textarea class="form-control" id="description" name="description" maxlength="500" rows="3">{{if .RecurringExpense}}{{.RecurringExpense.Description}}{{end}}</textarea>
    </div>
    <div class="mb-3">
        <label for="category" class="form-label">{{t "category"}}</label>
        <select class="form-select" id="category" name="category_id" required>
            <option value="">{{t "select"}}</option>
            {{$catID := 0}}{{if .RecurringExpense}}{{$catID = .RecurringExpense.CategoryID}}{{end}}
            {{range .Categories}}
            <option value="{{.ID}}" {{if eq .ID $catID}}selected{{end}}>{{.Name}}</option>
            {{end}}
            <option value="NEW">{{t "new_category"}}</option>
        </select>
        <input type="text" class="form-control mt-2 d-none" id="new-category-name" name="new_category_name" placeholder="{{t "category_name"}}" maxlength="50">
    </div>
    <div class="mb-3">
        <label for="frequency" class="form-label">{{t "frequency"}}</label>
        <select class="form-select" id="frequency" name="frequency" required>
            {{$freq := ""}}{{if .RecurringExpense}}{{$freq = .RecurringExpense.Frequency}}{{end}}
            {{range .Frequencies}}
            <option value="{{.}}" {{if eq . $freq}}selected{{else}}{{if and (eq $freq "") (eq . "monthly")}}selected{{end}}{{end}}>{{tf (printf "%s" .)}}</option>
            {{end}}
        </select>
    </div>
    <div class="mb-3">
        <label for="start_date" class="form-label">{{t "start_date"}}</label>
        <div class="input-group">
            <input type="date" class="form-control" id="start_date" name="start_date" required value="{{if .RecurringExpense}}{{formatDateISO .RecurringExpense.StartDate}}{{end}}">
            <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('start_date').valueAsDate = new Date()">{{t "today"}}</button>
        </div>
    </div>
    <div class="mb-3">
        <label for="end_date" class="form-label">{{t "end_date"}} <small class="text-muted">({{t "end_date_optional"}})</small></label>
        <input type="date" class="form-control" id="end_date" name="end_date" value="{{if .RecurringExpense}}{{if .RecurringExpense.EndDate}}{{formatDateISO (derefTime .RecurringExpense.EndDate)}}{{end}}{{end}}">
    </div>
    {{if .RecurringExpense}}
    <div class="mb-3 form-check">
        <input type="checkbox" class="form-check-input" id="active" name="active" {{if .RecurringExpense.Active}}checked{{end}}>
        <label class="form-check-label" for="active">{{t "active"}}</label>
    </div>
    {{end}}
    <button type="submit" class="btn btn-primary">{{t "save"}}</button>
    <a href="/households/{{.Household.ID}}/recurring" class="btn btn-secondary">{{t "cancel"}}</a>
</form>

{{if .RecurringExpense}}
<hr class="mt-4">
<h3>{{t "schedule_overrides"}}</h3>
<p class="text-muted small">{{t "schedule_overrides_help"}}</p>

{{if .ScheduleOverrides}}
<table class="table" style="max-width: 600px;">
    <thead>
        <tr>
            <th>{{t "effective_date"}}</th>
            <th>{{t "amount"}}</th>
            <th>{{t "frequency"}}</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {{range .ScheduleOverrides}}
        <tr>
            <td>{{formatDate .EffectiveDate}}</td>
            <td>{{formatMoney .Amount}}</td>
            <td>{{tf (printf "%s" .Frequency)}}</td>
            <td class="text-end">
                <form method="POST" action="/households/{{$.Household.ID}}/recurring/{{$.RecurringExpense.ID}}/overrides/{{.ID}}/delete" style="display:inline">
                    <button type="submit" class="btn btn-sm btn-outline-danger" title="{{t "delete"}}"><span class="material-symbols-outlined" style="font-size:18px">delete</span></button>
                </form>
            </td>
        </tr>
        {{end}}
    </tbody>
</table>
{{end}}

<form method="POST" action="/households/{{.Household.ID}}/recurring/{{.RecurringExpense.ID}}/overrides" class="d-flex gap-2 align-items-end flex-wrap" style="max-width: 600px;">
    <div>
        <label class="form-label small">{{t "effective_date"}}</label>
        <input type="date" class="form-control form-control-sm" name="effective_date" required>
    </div>
    <div>
        <label class="form-label small">{{t "type"}}</label>
        <select class="form-select form-select-sm" name="type">
            <option value="expense">{{t "expense"}}</option>
            <option value="income">{{t "income"}}</option>
        </select>
    </div>
    <div>
        <label class="form-label small">{{t "amount"}}</label>
        <input type="text" class="form-control form-control-sm" name="amount" required placeholder="e.g. 42.50" style="width: 120px;">
    </div>
    <div>
        <label class="form-label small">{{t "frequency"}}</label>
        <select class="form-select form-select-sm" name="frequency" required>
            {{range .Frequencies}}
            <option value="{{.}}" {{if eq . "monthly"}}selected{{end}}>{{tf (printf "%s" .)}}</option>
            {{end}}
        </select>
    </div>
    <div>
        <button type="submit" class="btn btn-sm btn-primary">{{t "add"}}</button>
    </div>
</form>
{{end}}

<script>
(function() {
    var catSel = document.getElementById('category');
    var newCat = document.getElementById('new-category-name');
    catSel.addEventListener('change', function() {
        if (catSel.value === 'NEW') {
            newCat.classList.remove('d-none');
            newCat.required = true;
        } else {
            newCat.classList.add('d-none');
            newCat.required = false;
            newCat.value = '';
        }
    });
})();
</script>
{{end}}
